<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pending Waste Tasks | Worker Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal-content::-webkit-scrollbar { width: 6px; }
    .modal-content::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
  </style>
</head>

<body class="bg-slate-50 font-sans min-h-screen pb-10">

  <header class="bg-emerald-800 text-white shadow-lg sticky top-0 z-40">
    <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex flex-col">
        <span class="text-[10px] uppercase tracking-widest opacity-80 font-bold">Authenticated Worker</span>
        <div class="flex items-center gap-2">
          <i class="fas fa-id-badge text-emerald-400"></i>
          <b id="workerName" class="text-sm"></b>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="loadPage('WorkCompleted')" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-1">
          <i class="fas fa-check-circle"></i> History
        </button>
        <button onclick="loadPage('Logout')" class="bg-red-500 hover:bg-red-600 px-3 py-2 rounded-lg text-xs font-bold transition">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-3xl mx-auto px-4 pt-8 pb-4 text-center">
    <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Pending Waste Tasks</h2>
    <div class="h-1 w-20 bg-emerald-500 mx-auto mt-2 rounded-full"></div>
  </div>

  <main class="max-w-3xl mx-auto px-4 space-y-4" id="taskContainer">
    <div class="bg-white p-12 rounded-2xl shadow-sm border border-slate-200 text-center text-slate-400">
      <i class="fas fa-circle-notch animate-spin text-3xl mb-3 text-emerald-500"></i>
      <p class="font-medium">Loading assigned tasks...</p>
    </div>
  </main>

  <div class="modal p-4" id="taskModal">
    <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden relative flex flex-col max-h-[90vh]">
      
      <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl z-50">
        <i class="fas fa-times-circle"></i>
      </button>

      <div class="bg-slate-900 p-6 text-white">
        <h3 id="mName" class="text-xl font-bold uppercase tracking-tight text-emerald-400 pr-6"></h3>
        <div class="flex items-center gap-3 mt-2 text-xs font-mono opacity-80">
          <span>TICKET: #<span id="mTicket"></span></span>
          <span class="h-3 w-px bg-slate-700"></span>
          <span><i class="fas fa-map-marker-alt text-emerald-500"></i> <span id="mRegion"></span></span>
        </div>
      </div>

      <div class="p-6 space-y-6 overflow-y-auto">
        <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
          <div class="text-sm font-bold text-slate-700">
            <i class="fas fa-phone-alt text-emerald-600 mr-2"></i> <span id="mPhone"></span>
          </div>
          <a id="mapLink" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-md shadow-blue-100" target="_blank">
            <i class="fas fa-directions"></i> Maps
          </a>
        </div>

        <div class="rounded-xl border-2 border-slate-100 overflow-hidden shadow-inner bg-slate-50">
          <iframe id="issueFrame" class="w-full h-64" allow="autoplay"></iframe>
        </div>

        <div class="bg-emerald-50 p-4 rounded-xl border-l-4 border-emerald-400">
          <p id="mDesc" class="text-sm text-slate-700 leading-relaxed"></p>
        </div>

        <div class="pt-6 border-t border-slate-100 space-y-4">
          <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest text-center">Reporting Completion</h4>

          <div class="space-y-4">
            <div class="flex flex-col gap-2">
              <label class="relative flex flex-col items-center justify-center w-full h-32 border-2 border-emerald-200 border-dashed rounded-2xl bg-emerald-50/50 cursor-pointer hover:bg-emerald-50 transition">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <i class="fas fa-cloud-upload-alt text-emerald-600 text-2xl mb-2"></i>
                  <p class="text-xs text-emerald-700 font-bold uppercase tracking-tight">Upload Proof Image</p>
                </div>
                <input type="file" id="doneImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
              </label>
              <div id="fileName" class="text-center text-[11px] text-slate-500 font-medium">No file chosen</div>
            </div>

            <textarea id="workers" placeholder="Worker Names (Eg. Rahul, Arranya)" 
              class="w-full p-4 text-sm bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 transition-all h-24 shadow-inner"></textarea>

            <label class="flex items-start gap-3 p-4 bg-slate-50 rounded-xl border border-slate-100 cursor-pointer group">
              <input type="checkbox" id="doneCheckbox" class="mt-0.5 w-5 h-5 text-emerald-600 border-slate-300 rounded focus:ring-emerald-500 cursor-pointer">
              <span class="text-xs text-slate-600 leading-tight font-medium group-hover:text-emerald-700 transition">
                Confirm that the waste has been completely cleared and site is sanitized.
              </span>
            </label>
          </div>

          <button class="submit-btn w-full py-4 bg-emerald-700 hover:bg-emerald-800 text-white font-black rounded-xl shadow-xl shadow-emerald-700/20 active:scale-95 transition-all uppercase tracking-widest text-sm" onclick="submitDone()">
            Submit Task as Done
          </button>
          
          <div id="statusMsg" class="text-center text-xs font-black min-h-[16px] uppercase tracking-tighter"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function () {
    "use strict";

    let currentTask = null;
    let refreshTimer = null;
    let submitInterval = null;

    /* ===== INIT ===== */
    document.getElementById("workerName").textContent =
      localStorage.getItem("LOGGEDINUSER") || "Worker";

    const doneImageInput = document.getElementById("doneImage");
    const fileNameSpan = document.getElementById("fileName");

    doneImageInput.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        if (file.size > 3 * 1024 * 1024) {
          alert("File size exceeds 3MB. Please select a smaller file.");
          this.value = "";
          fileNameSpan.textContent = "No file chosen";
          return;
        }
        fileNameSpan.textContent = "Selected: " + file.name;
        fileNameSpan.classList.add("text-emerald-600");
      } else {
        fileNameSpan.textContent = "No file chosen";
        fileNameSpan.classList.remove("text-emerald-600");
      }
    });

    /* ===== NAV ===== */
    function loadPage(page) {
      google.script.run.withSuccessHandler(html => {
        document.open();
        document.write(html);
        document.close();
      }).loadPage(page);
    }

    /* ===== HELPERS ===== */
    function extractDriveId(url) {
      const m = url.match(/[-\w]{25,}/);
      return m ? m[0] : "";
    }

    /* ===== TASK FLOW ===== */
    function loadTasks() {
      const region = localStorage.getItem("USER_REGION");
      google.script.run.withSuccessHandler(renderTasks)
        .getPendingTasksByRegion(region);
    }

    function renderTasks(tasks) {
      const box = document.getElementById("taskContainer");
      box.innerHTML = "";

      if (!tasks.length) {
        box.innerHTML = `
          <div class="bg-white p-12 rounded-2xl shadow-sm border border-slate-200 text-center">
             <i class="fas fa-medal text-4xl text-yellow-400 mb-3"></i>
             <p class="text-slate-600 font-bold">No pending tasks! All clear in your region.</p>
          </div>`;
        return;
      }

      tasks.forEach(t => {
        const div = document.createElement("div");
        div.className = "bg-white p-5 rounded-2xl border-l-8 border-emerald-500 shadow-sm hover:shadow-md hover:translate-x-1 transition-all cursor-pointer flex justify-between items-center group";
        div.innerHTML = `
          <div class="flex-1">
            <div class="text-xs font-black text-emerald-600 uppercase mb-1 tracking-widest">Ticket #${t.ticket}</div>
            <div class="text-lg font-bold text-slate-800 leading-tight group-hover:text-emerald-700 transition">${t.name}</div>
            <div class="text-sm text-slate-500 mt-1 line-clamp-1 italic">${t.description}</div>
          </div>
          <div class="ml-4 text-slate-300 group-hover:text-emerald-500 transition">
            <i class="fas fa-chevron-right text-xl"></i>
          </div>
        `;
        div.onclick = () => openModal(t);
        box.appendChild(div);
      });
    }

    function openModal(t) {
      currentTask = t;
      clearInterval(refreshTimer);

      document.getElementById("mName").textContent = t.name;
      document.getElementById("mTicket").textContent = t.ticket;
      document.getElementById("mPhone").textContent = t.phone;
      document.getElementById("mRegion").textContent = t.region;
      document.getElementById("mDesc").textContent = t.description;

      const id = extractDriveId(t.image);
      document.getElementById("issueFrame").src =
        `https://drive.google.com/file/d/${id}/preview`;

      document.getElementById("mapLink").href =
        `https://www.google.com/maps/search/?api=1&query=${t.lat},${t.lng}`;

      const submitBtn = document.querySelector(".submit-btn");
      submitBtn.disabled = true;
      submitBtn.classList.replace("bg-emerald-700", "bg-slate-300");

      const checkbox = document.getElementById("doneCheckbox");
      checkbox.checked = false;
      checkbox.onchange = function () {
        submitBtn.disabled = !this.checked;
        if(this.checked) {
            submitBtn.classList.replace("bg-slate-300", "bg-emerald-700");
        } else {
            submitBtn.classList.replace("bg-emerald-700", "bg-slate-300");
        }
      };

      document.getElementById("statusMsg").textContent = "";
      document.getElementById("taskModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("taskModal").style.display = "none";
      refreshTimer = setInterval(loadTasks, 5000);
      clearInterval(submitInterval);
      submitInterval = null;
    }

    function submitDone() {
      const file = document.getElementById("doneImage").files[0];
      const workers = document.getElementById("workers").value.trim();
      const checkbox = document.getElementById("doneCheckbox");
      const statusEl = document.getElementById("statusMsg");
      const submitBtn = document.querySelector(".submit-btn");

      if (!file || !workers || !checkbox.checked) {
        statusEl.style.color = "#e11d48";
        statusEl.textContent = "Error: All fields and checkbox are required";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.classList.replace("bg-emerald-700", "bg-slate-300");

      let dots = 0;
      statusEl.style.color = "#047857";
      submitInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        statusEl.textContent = "Uploading Data" + ".".repeat(dots);
      }, 500);

      const reader = new FileReader();
      reader.onload = e => {
        google.script.run
          .withSuccessHandler(msg => {
            clearInterval(submitInterval);
            submitInterval = null;
            statusEl.textContent = "SUCCESS: " + msg;
            setTimeout(() => {
                closeModal();
                loadTasks();
            }, 1500);
          })
          .withFailureHandler(err => {
            clearInterval(submitInterval);
            submitInterval = null;
            statusEl.style.color = "#e11d48";
            statusEl.textContent = "FAILED: " + (err.message || "System error");
            submitBtn.disabled = false;
            submitBtn.classList.replace("bg-slate-300", "bg-emerald-700");
          })
          .completeTask({
            ticket: currentTask.ticket,
            image: e.target.result.split(",")[1],
            imageName: file.name,
            workers,
            loggedInUser: localStorage.getItem("LOGGEDINUSER") || ""
          });
      };
      reader.readAsDataURL(file);
    }

    /* ===== EXPOSE REQUIRED FUNCTIONS ===== */
    window.loadPage = loadPage;
    window.closeModal = closeModal;
    window.submitDone = submitDone;

    window.onload = () => {
      loadTasks();
      refreshTimer = setInterval(loadTasks, 5000);
    };

  })();
  </script>
</body>
</html>
